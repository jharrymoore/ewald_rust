use pyo3::ffi::PyRun_InteractiveLoop;
use pyo3::prelude::*;

use std::f64::consts::PI;

use numpy::ndarray::{
    s, Array, ArrayBase, ArrayD, ArrayViewD, ArrayViewMutD, OwnedArcRepr, OwnedRepr,
};
use numpy::{Complex64, IntoPyArray, PyArrayDyn, PyReadonlyArray1, PyReadonlyArray2};
use pyo3::{pymodule, types::PyModule, PyResult, Python};
use statrs::function::erf::erfc;

/// Formats the sum of two numbers as string.
#[pyfunction]
fn real_space_sum(r: PyReadonlyArray2<f64>, q: PyReadonlyArray1<f64>, kappa: f64) -> PyResult<f64> {
    // sum over all pairs of charges

    let r = r.as_array();
    let q = q.as_array();
    let mut energy = 0.0;
    for i in 0..q.len() {
        for j in 0..q.len() {
            if i != j {
                let r_ij = &r.row(i) - &r.row(j);
				// subtract the nearest integer from r_ij
				let r_ij = r_ij.mapv(|x| x - x.round());
                let r_ij_norm = r_ij.dot(&r_ij).sqrt();
                energy += q[i] * q[j] * erfc(kappa * r_ij_norm) / r_ij_norm;
            }
        }
    }

    Ok(energy / 2.0)
}

#[pyfunction]
fn reciprocal_space_sum(
    nk: usize,
    r: PyReadonlyArray2<f64>,
    q: PyReadonlyArray1<f64>,
    kappa: f64,
) -> PyResult<f64> {
    // sum over all pairs of charges
    // convert numpy to ndarray
    // deconstruct the dimentions of the r array
    let n = r.shape()[0];
    let d = r.shape()[1];

    let r = r.as_array();
    let q = q.as_array();
    let mut energy = 0.0;
    let two_pi = 2.0 * std::f64::consts::PI;
    let two_pi_sq = two_pi * two_pi;

    // if first_call {
    let b = 1. / 4. / kappa / kappa;
    let k_sq_max = nk.pow(2);
    // allocate zero vector for k
    let mut k_fac: ArrayBase<OwnedRepr<f64>, _> = Array::zeros(k_sq_max + 1);

    // loop over all k vectors in three dims
    for kx in 0..nk {
        for ky in 0..nk {
            for kz in 0..nk {
                let k_sq = kx.pow(2) + ky.pow(2) + kz.pow(2);

                if k_sq <= k_sq_max && k_sq > 0{
                    let kr_sq = two_pi_sq * k_sq as f64;
                    k_fac[k_sq] = two_pi * (-b * kr_sq).exp() / kr_sq;
                }
            }
        }
    }

    // initialize the k_vectors
    let mut eikx: ArrayBase<OwnedRepr<Complex64>, _> = Array::zeros((n, nk + 1));
    let mut eiky: ArrayBase<OwnedRepr<Complex64>, _> = Array::zeros((n, 2 * nk + 1));
    let mut eikz: ArrayBase<OwnedRepr<Complex64>, _> = Array::zeros((n, 2 * nk + 1));

    // calculate kx, ky, kz  = 0
    for i in 0..n {
        eikx[[i, 0]] = Complex64::new(1.0, 0.0);
        eiky[[i, nk+0]] = Complex64::new(1.0, 0.0);
        eikz[[i, nk+0]] = Complex64::new(1.0, 0.0);

        // now kx,ky,kz  = 1
        eikx[[i, 1]] = Complex64::new((two_pi * r[[i, 0]]).cos(), (two_pi * r[[i, 0]]).sin());
        eiky[[i, nk+1]] = Complex64::new((two_pi * r[[i, 1]]).cos(), (two_pi * r[[i, 1]]).sin());
        eikz[[i, nk+1]] = Complex64::new((two_pi * r[[i, 2]]).cos(), (two_pi * r[[i, 2]]).sin());
    }
    // now get the rest of the kx,ky,kz


    for k in 2..nk + 1 {
		
		// eikx.slice_mut(s![..,k]) = &eikx.slice(s![..,k-1]) * &eikx.slice(s![..,1]);
		// eiky.slice_mut(s![..,nk+k]) = &eiky.slice(s![..,nk+k-1]) * &eiky.slice(s![..,nk+1]);
		// eikz.slice_mut(s![..,nk+k]) = &eikz.slice(s![..,nk+k-1]) * &eikz.slice(s![..,nk+1]);
	// }
        for i in 0..n {
            eikx[[i, k]] = eikx[[i, k - 1]] * eikx[[i, 1]];
            eiky[[i, nk+k]] = eiky[[i, nk + k - 1]] * eiky[[i, nk + 1]];
            eikz[[i, nk+k]] = eikz[[i, nk + k - 1]] * eikz[[i, nk + 1]];
        }
    }

    for i in 0..n {
        for j in 0..nk {
            eiky[[i, j]] = eiky[[i, 2 * nk - j]].conj();
            eikz[[i, j]] = eikz[[i, 2 * nk - j]].conj();
        }
    }

    let mut pot = 0.0;
	let mut i = 0;

    // write the main loop to iterate over k vectors
    // positive kx vectors
    for kx in (0 as i32)..(nk as i32 + 1) {
        let factor = match kx {
            0 => 1.0,
            _ => 2.0,
        };
        for ky in (-1 * nk as i32)..(nk as i32 + 1) {
            for kz in (-1 * nk as i32)..(nk as i32 + 1) {
                let k_sq = kx.pow(2) + ky.pow(2) + kz.pow(2);

                if k_sq <= k_sq_max as i32  && k_sq > 0 {
                    let term = &eikx.slice(s!(.., kx as usize))
                        * &eiky.slice(s!(.., ky + nk as i32))
                        * &eikz.slice(s!(.., kz + nk as i32))
                        * &q.slice(s![..]);
					let term  = term.sum();
					pot += factor * k_fac[k_sq as usize] * (term * term.conj()).re;
                }
            }
        }
    }
    pot = pot - kappa * q.slice(s![..]).map(|v| v.powi(2)).sum() / PI.sqrt();

    Ok(pot)
}

/// A Python module implemented in Rust.
#[pymodule]
fn ewald_rust(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(real_space_sum, m)?)?;
    m.add_function(wrap_pyfunction!(reciprocal_space_sum, m)?)?;

    Ok(())
}

#[cfg(test)]
mod tests {
    use numpy::{
        ndarray::{Array1, Array2, ArrayView2},
        PyArray1, PyArray2, PyReadonlyArray,
    };
    use pyo3::types::IntoPyDict;
    use statrs::assert_almost_eq;

    use super::*;

    #[test]
    fn test_real_space_sum() {
        Python::with_gil(|py| {

            let coords = PyArray2::from_vec2(
                py,
                &[
                    vec![3.77701194e-01, 4.67772786e-01, -3.95522676e-01],
                    vec![4.53757903e-01, 1.61092870e-01, -6.60387998e-02],
                    vec![-4.64901145e-01, 4.32659892e-01, -3.74928594e-01],
                    vec![2.22596395e-01, 1.83711841e-01, 2.37328646e-01],
                    vec![4.98373169e-01, 1.26445312e-01, -1.51174544e-01],
                    vec![4.13160461e-01, 1.48616234e-01, -1.30509139e-01],
                    vec![-3.31410415e-02, -3.11451448e-01, 4.46678741e-02],
                    vec![-2.08542425e-01, -1.15534852e-01, 3.74073110e-01],
                    vec![4.72775687e-01, -4.39546850e-01, -4.67239205e-01],
                    vec![-1.06151872e-01, 3.12583661e-01, -1.49799235e-01],
                    vec![4.02121444e-01, -4.33214612e-02, -7.14701237e-02],
                    vec![2.47579873e-01, 3.54881183e-02, -1.92733447e-01],
                    vec![4.38331739e-01, 8.75849842e-02, -1.75260920e-02],
                    vec![2.86596144e-04, -1.84851507e-01, 1.29260624e-01],
                    vec![3.80144490e-01, -4.73704352e-02, -1.53959063e-01],
                    vec![1.36975665e-01, 2.86562730e-02, -2.97376644e-01],
                    vec![-4.72122298e-01, 6.48243819e-02, -1.88156805e-01],
                    vec![-3.93054817e-01, -3.20061912e-01, 4.24409000e-01],
                    vec![2.75965612e-01, 1.39040603e-01, 1.94285700e-01],
                    vec![-4.07117465e-01, -1.17647360e-01, 3.85494219e-01],
                    vec![2.35130661e-02, 3.71219391e-01, -2.98522219e-02],
                    vec![3.65137372e-01, 1.09227494e-01, -2.03635520e-01],
                    vec![-2.65471503e-02, 2.47973267e-01, -1.45101264e-02],
                    vec![-2.01501012e-01, 2.39913144e-01, -1.59521211e-01],
                    vec![-1.43043614e-01, 3.90157075e-01, -1.22480061e-01],
                    vec![6.94346066e-03, 2.35248131e-01, -1.72255515e-01],
                    vec![1.01782213e-01, 1.01274816e-01, -2.87894854e-01],
                    vec![2.95897739e-03, 4.61762965e-01, -1.43430095e-01],
                    vec![-4.61375238e-01, -3.56915139e-01, -3.50904730e-01],
                    vec![1.71326214e-01, -3.90450699e-02, -2.69656080e-01],
                    vec![1.29171165e-01, 8.79364478e-02, -2.13960055e-01],
                    vec![-4.08181971e-01, -4.42019046e-01, -1.80808038e-01],
                    vec![3.79849001e-01, 1.24091291e-01, -6.33223368e-02],
                    vec![3.70160324e-01, 1.63952667e-01, 2.91069957e-01],
                    vec![-3.91260518e-01, -3.78672858e-01, -2.18948391e-01],
                    vec![-7.46225950e-02, 2.08635270e-01, -6.42851616e-02],
                    vec![4.07199291e-01, 1.40113168e-01, 1.53735999e-01],
                    vec![-3.67250791e-01, -7.76317285e-02, 3.16574417e-01],
                    vec![-8.30342655e-02, 1.89581946e-01, -2.06135144e-01],
                    vec![4.59006573e-01, 2.14991372e-02, -5.34543053e-02],
                    vec![-4.27285538e-01, -3.11560366e-01, 2.61103416e-01],
                    vec![4.67270332e-01, 3.80303104e-01, -3.76277215e-01],
                    vec![1.94854636e-01, 2.53217719e-01, 2.97371036e-01],
                    vec![-4.04240014e-01, -1.48777120e-01, 3.07487226e-01],
                    vec![4.43056375e-01, 1.88313853e-01, 2.93368240e-01],
                    vec![2.77614745e-03, -1.68517490e-01, 4.79581754e-02],
                    vec![4.95884306e-01, -3.67631712e-01, -2.83912399e-01],
                    vec![3.26911187e-01, 2.89984450e-01, 3.00251583e-01],
                    vec![-1.54131681e-01, -2.33139819e-01, 1.20345374e-01],
                    vec![-1.40877492e-01, 3.55995724e-01, -1.53574653e-03],
                    vec![4.94569206e-01, 4.22566712e-01, -4.45820483e-01],
                    vec![-4.35384046e-01, -4.61664180e-01, -4.55658509e-01],
                    vec![-1.87760097e-01, 2.56380174e-01, -2.46867525e-01],
                    vec![-4.44137013e-01, 4.85732588e-01, -2.98718100e-01],
                    vec![-3.59824555e-01, -2.67196385e-01, 3.69482284e-01],
                    vec![4.56303406e-01, 2.91226244e-01, 1.04002470e-01],
                    vec![4.21446676e-01, 4.02682962e-01, -4.37765449e-01],
                    vec![-1.15533366e-02, -2.41387446e-01, 7.03796823e-02],
                    vec![3.64214248e-01, 4.63072953e-01, -4.76412179e-01],
                    vec![-1.05298415e-01, -2.94039925e-01, 1.50283872e-01],
                    vec![-1.12375784e-01, -1.64833750e-01, 1.43488219e-01],
                    vec![3.46826571e-01, 2.28574574e-01, 2.42599038e-01],
                    vec![-4.76251676e-01, -4.29063980e-01, -3.89826474e-01],
                    vec![4.49527531e-01, -1.95216623e-02, -1.87915407e-01],
                    vec![-3.47406092e-02, -3.01765480e-01, 1.21326882e-01],
                    vec![4.51169865e-01, 8.70489443e-02, -9.37759563e-02],
                    vec![2.85062465e-01, 1.04983498e-01, -2.11001882e-01],
                    vec![3.38719745e-01, 8.43061802e-02, 2.70951971e-01],
                    vec![4.25033721e-01, 2.56931170e-01, 2.60511527e-01],
                    vec![2.44843491e-01, 9.91656627e-02, -1.40714067e-01],
                    vec![4.74025323e-01, -4.95716958e-02, -1.13788008e-01],
                    vec![2.79787555e-01, 2.18697220e-01, 1.90821462e-01],
                    vec![3.37466366e-01, -3.75240106e-03, -1.04073086e-01],
                    vec![4.77770722e-01, 4.36392549e-01, -3.11930455e-01],
                    vec![8.56521368e-04, 2.24476194e-01, -8.91941006e-02],
                    vec![4.40152875e-01, -4.61336403e-01, -3.94884904e-01],
                    vec![5.30064196e-02, 4.14390688e-01, -9.92344735e-02],
                    vec![-4.15114132e-01, -2.40202868e-01, 3.20162495e-01],
                    vec![3.18634842e-01, 2.12838389e-01, 3.22030694e-01],
                    vec![-1.76944650e-01, -2.85132073e-01, 1.82097861e-01],
                    vec![3.46206222e-01, 1.92566586e-01, 1.49725780e-01],
                    vec![-3.38259353e-01, -2.04589009e-01, 3.12254439e-01],
                    vec![-6.08507287e-02, -3.55247217e-01, 1.66835398e-01],
                    vec![3.19061794e-01, 3.59250634e-01, 2.53839640e-01],
                    vec![-4.75594430e-01, -2.89397102e-01, 3.29959740e-01],
                    vec![4.20298630e-01, 4.96687496e-01, -3.26161782e-01],
                    vec![4.80441323e-01, -4.94889089e-01, -2.73069535e-01],
                    vec![3.02278980e-01, 4.10111977e-01, 1.90029672e-01],
                    vec![3.03690208e-01, 2.88832030e-01, 2.22036970e-01],
                    vec![3.71085757e-01, 1.81315547e-01, 3.79726469e-01],
                    vec![2.46055499e-01, 1.12560056e-01, -3.38202741e-01],
                    vec![2.53386814e-01, -1.78929971e-02, -2.49464027e-01],
                    vec![4.05214909e-01, 4.10105666e-01, -3.34433073e-01],
                    vec![3.76908447e-01, 7.59017982e-02, -1.24073394e-01],
                    vec![2.55543347e-01, 3.49367116e-01, 2.01469096e-01],
                    vec![2.70614483e-01, 2.38245509e-01, 2.68762155e-01],
                    vec![-4.79099209e-02, 3.38432391e-01, -3.66475091e-02],
                    vec![-1.11631398e-01, 2.39969884e-01, -2.68114803e-01],
                    vec![-7.85484823e-02, 4.42541394e-01, -1.28513381e-01],
                    vec![-4.87158122e-01, 8.90287311e-02, -4.34304063e-02],
                    vec![8.80513050e-02, 3.48211556e-01, -7.86461123e-02],
                    vec![4.17553429e-01, 2.22880566e-01, 1.21514617e-01],
                    vec![-3.91219739e-01, -1.98525547e-01, 3.81626961e-01],
                    vec![-4.26231945e-02, -3.40461873e-01, 2.47310909e-01],
                    vec![3.85283742e-01, 3.87045182e-01, 2.23608151e-01],
                    vec![6.56340545e-02, -2.25296571e-01, 1.11822304e-01],
                    vec![-2.17664214e-01, -4.66996928e-02, 3.41317789e-01],
                    vec![-1.89168847e-01, 3.19032940e-01, -1.17512681e-01],
                    vec![-4.79833599e-01, -2.94722580e-01, -1.45902016e-01],
                    vec![-1.44635979e-01, -3.60491457e-01, 1.56546745e-01],
                    vec![-2.90397148e-02, 4.28763987e-01, -6.71517617e-02],
                    vec![4.11168791e-01, 3.33998656e-01, 1.61770732e-01],
                    vec![3.82923043e-02, -3.02080921e-01, 9.68166432e-02],
                    vec![3.68637844e-01, -4.60443818e-01, -3.57589200e-01],
                    vec![3.79603476e-01, 3.11113233e-01, 2.32751804e-01],
                    vec![-8.52466827e-02, 3.75592972e-01, -1.92532857e-01],
                    vec![1.26364213e-02, -2.54460253e-01, 1.62090106e-01],
                    vec![-7.67096911e-03, 3.84078154e-01, -1.73984634e-01],
                    vec![-4.32339047e-01, 4.55538704e-01, -4.43909234e-01],
                    vec![-3.57049663e-01, -3.56615653e-01, 2.72474655e-01],
                    vec![3.12679265e-01, 1.72496798e-01, -2.17340384e-01],
                    vec![1.96560075e-01, -2.39495668e-02, -1.85588940e-01],
                    vec![3.11050830e-01, 7.16702977e-02, -7.97699740e-02],
                    vec![1.85871693e-01, 3.23512862e-02, -2.42677992e-01],
                    vec![2.35828477e-01, 1.71010536e-01, -1.87968101e-01],
                    vec![4.64388043e-01, -3.68036663e-01, -3.88195006e-01],
                    vec![3.83691323e-01, 4.11356827e-02, -5.40120242e-02],
                    vec![3.87792810e-01, 2.46960592e-01, 3.30433049e-01],
                    vec![-4.00095275e-01, -4.54891260e-01, -2.59316185e-01],
                    vec![-4.86549245e-02, -1.23427320e-01, 1.15749671e-01],
                    vec![-4.67504027e-01, -4.33311949e-01, -3.06276964e-01],
                    vec![4.66347252e-01, 3.34131357e-01, 2.27100230e-01],
                    vec![1.68617784e-03, 3.20119317e-01, 2.63826456e-02],
                    vec![3.75718434e-01, 2.92656858e-01, 9.97098251e-02],
                    vec![4.79161754e-01, -3.56596153e-01, -1.97860698e-01],
                    vec![2.80634327e-01, 2.81675545e-01, 1.45348616e-01],
                    vec![3.24867809e-01, 1.33719407e-01, -1.42283063e-01],
                    vec![-1.02137496e-01, 4.05103683e-01, -5.60489166e-02],
                    vec![1.55722521e-01, 1.57432153e-01, -2.47576099e-01],
                    vec![-4.98475883e-01, 3.31366733e-02, -1.24015753e-01],
                    vec![3.20495130e-01, 1.11728824e-01, -2.86993086e-01],
                    vec![-2.66372458e-01, -1.73641493e-01, 3.44649634e-01],
                    vec![4.60205323e-01, -4.26438363e-01, -2.42603899e-01],
                    vec![-4.63618997e-01, -1.86387743e-01, 3.54348281e-01],
                    vec![-1.82628644e-01, 2.98561217e-01, -3.52537701e-02],
                    vec![-1.01054591e-01, 3.09376286e-01, -2.34044705e-01],
                    vec![-9.19883377e-02, -3.46024858e-01, 8.80814617e-02],
                    vec![-8.45175964e-02, 3.22430513e-01, 3.74745658e-02],
                    vec![8.00506627e-03, 3.49170637e-01, -1.01891658e-01],
                    vec![2.53377904e-01, 3.18679924e-01, 2.80877738e-01],
                    vec![-4.04673536e-01, -3.23900478e-01, 3.38202067e-01],
                    vec![2.47633047e-01, 1.47861635e-01, -2.62719501e-01],
                    vec![-3.51308208e-01, -2.77110047e-01, 2.80635162e-01],
                    vec![2.27133548e-01, 2.72703331e-01, 2.15075045e-01],
                    vec![4.24713602e-01, 1.40446519e-02, -1.24378405e-01],
                    vec![-4.89998903e-02, 3.94840107e-01, 2.02881790e-02],
                    vec![-1.70087707e-02, -1.72378141e-02, -3.50283866e-01],
                    vec![2.06709851e-01, 1.00194697e-01, -2.12926319e-01],
                    vec![-4.51396873e-01, -3.33059771e-01, -2.38084990e-01],
                    vec![2.62807328e-01, 9.73876338e-03, -1.17357527e-01],
                    vec![2.81194114e-01, 1.95121989e-01, 3.97041481e-01],
                    vec![3.64962747e-01, 2.66624594e-01, 1.73294057e-01],
                    vec![-1.23852253e-01, 3.30062332e-01, -7.49886693e-02],
                    vec![2.92093029e-01, 1.62630716e-01, 2.67234898e-01],
                    vec![4.08139390e-01, 3.65011957e-01, 8.45503005e-02],
                    vec![-9.00730724e-02, -2.65533060e-01, 6.91048412e-02],
                    vec![-4.31002207e-02, 2.55861720e-01, -2.31339910e-01],
                    vec![7.02434558e-02, 1.29653943e-02, -3.35657227e-01],
                    vec![-4.64214099e-01, 4.95110899e-01, -2.21082821e-01],
                    vec![-1.10004706e-01, 2.69982680e-01, -2.54592133e-02],
                    vec![4.46760606e-01, 2.64348603e-01, 1.85677455e-01],
                    vec![3.02285726e-02, 2.92300886e-01, -4.79888956e-02],
                    vec![4.43996811e-02, -1.84543655e-01, 1.93128056e-01],
                    vec![-3.36207996e-01, -1.41968118e-01, 3.60766036e-01],
                    vec![1.26406405e-01, 8.10985138e-03, -2.05395640e-01],
                    vec![-7.28920761e-02, -1.87152383e-01, 6.92951511e-02],
                    vec![1.48144138e-02, -2.29317186e-02, -2.66307759e-01],
                    vec![5.98978884e-02, -6.87312693e-02, -3.27315042e-01],
                    vec![9.23156878e-02, -2.82430154e-02, -2.68680126e-01],
                    vec![-1.63273309e-01, -3.11237477e-01, 1.00538181e-01],
                    vec![1.80832880e-01, 9.22692895e-02, -2.93506161e-01],
                    vec![4.35539253e-01, 4.79588236e-01, -4.56976074e-01],
                    vec![-1.28059366e-01, 2.49503877e-01, -1.87661383e-01],
                    vec![-4.06804930e-01, -3.05506209e-01, -1.81515910e-01],
                    vec![3.71324494e-01, 4.03590748e-01, 1.45723848e-01],
                    vec![-1.73955881e-01, 3.09493462e-01, -1.94314106e-01],
                    vec![-3.84417466e-02, -1.91553790e-01, 1.99980717e-01],
                    vec![1.44193289e-01, -4.00802906e-02, -3.43390991e-01],
                    vec![-1.36009895e-01, 1.85883029e-01, -1.36033813e-01],
                    vec![-3.26975289e-01, -3.39683956e-01, 3.53108641e-01],
                    vec![-2.83932360e-02, 3.04250296e-01, -1.59114559e-01],
                    vec![5.52510622e-02, -2.81564920e-02, -1.95294343e-01],
                    vec![3.25154413e-01, 3.51400204e-01, 9.68298595e-02],
                    vec![-1.10975352e-02, -8.49231665e-02, -3.04390420e-01],
                    vec![3.70803187e-02, 3.02825529e-01, -2.03135657e-01],
                    vec![-4.15688350e-01, -3.73003235e-01, -2.92195282e-01],
                    vec![-4.24460483e-01, 4.98788682e-01, -3.78531605e-01],
                    vec![4.46338949e-01, 6.86628714e-02, -1.78692391e-01],
                    vec![2.02515201e-01, 1.63353302e-02, -3.32020312e-01],
                    vec![-6.16032817e-02, -2.30115238e-01, 1.34744223e-01],
                    vec![4.17152468e-01, 1.95000187e-01, 2.15314122e-01],
                    vec![-2.79341826e-01, -1.38410049e-01, 4.15417654e-01],
                    vec![4.20551944e-01, 1.14538696e-01, 2.46529065e-01],
                    vec![3.08458911e-01, -1.92643328e-02, -1.80779706e-01],
                    vec![2.55671554e-01, 2.63817679e-01, 3.46900622e-01],
                    vec![1.17391304e-01, -9.93796714e-02, -2.83815940e-01],
                    vec![5.16285016e-02, -1.50447283e-01, -3.15692304e-01],
                    vec![-4.94484036e-01, 4.99452234e-01, -4.24682964e-01],
                    vec![1.63013528e-01, 1.35825255e-01, -1.48009917e-01],
                    vec![-1.61461773e-01, 1.86567530e-01, -2.21412057e-01],
                    vec![-1.33666958e-01, 2.58063514e-01, -1.01627471e-01],
                    vec![-3.05703868e-01, -2.08793158e-02, 3.45188950e-01],
                    vec![-2.80657345e-01, -9.91229355e-02, 3.38150335e-01],
                    vec![3.51525337e-01, 1.46618934e-01, 2.17836604e-01],
                    vec![4.01356056e-02, -9.19206745e-02, -2.43146965e-01],
                    vec![3.05281392e-01, 1.64823238e-02, -3.12086971e-01],
                    vec![-4.77764087e-02, -2.80145095e-01, 2.00107647e-01],
                    vec![-3.36650723e-01, -7.97556606e-02, 4.10142344e-01],
                    vec![7.00477036e-02, 3.64889240e-01, -1.57670243e-01],
                    vec![3.19953662e-01, 4.23781081e-02, -2.38936192e-01],
                    vec![4.36856660e-01, 4.27802527e-01, 4.87861900e-01],
                    vec![-2.91369105e-01, -2.62473385e-01, 3.32748836e-01],
                    vec![-4.04201698e-01, -4.19792279e-01, -3.53451113e-01],
                    vec![1.76248512e-02, -3.28077314e-01, 1.93457432e-01],
                    vec![-4.51601900e-01, -3.75871232e-01, -1.62791884e-01],
                    vec![4.99998240e-01, -4.95657758e-01, -3.47191966e-01],
                    vec![-6.59323826e-02, 3.66110921e-01, -1.11371830e-01],
                    vec![-5.89341479e-02, 2.82229958e-01, -8.90534483e-02],
                    vec![3.78586403e-01, 2.64714277e-02, -1.93107831e-01],
                    vec![-1.94142252e-01, 3.75038541e-01, -5.75783057e-02],
                    vec![2.51702293e-01, 6.56584860e-02, -2.74721859e-01],
                    vec![-3.10135906e-01, -2.12696643e-01, 3.96982622e-01],
                    vec![-4.97591343e-01, 4.79490667e-01, 4.98702364e-01],
                    vec![-3.71063875e-01, -2.40005973e-01, 4.45749352e-01],
                    vec![-6.62542922e-02, 2.29546938e-01, -1.44476391e-01],
                    vec![3.11359054e-01, 5.51626618e-02, -1.59196526e-01],
                    vec![1.20774860e-01, -6.78832281e-02, -2.08624018e-01],
                    vec![-4.62669672e-01, -4.13772164e-01, -2.28853942e-01],
                    vec![-1.15103420e-01, -3.21082909e-01, 2.23354433e-01],
                    vec![1.13197106e-01, -1.08655438e-01, -3.68503749e-01],
                    vec![-1.13500797e-01, -2.31398756e-01, 1.98457475e-01],
                    vec![-4.96123065e-01, -4.44867900e-01, -1.66589922e-01],
                    vec![-2.67588850e-02, 3.33915727e-01, -2.35507333e-01],
                    vec![3.14707468e-01, 1.37444869e-01, 3.40461103e-01],
                    vec![1.77936002e-01, 5.06242993e-02, -1.55197769e-01],
                    vec![4.51834828e-01, 4.56226045e-01, -3.86026957e-01],
                    vec![-4.40499801e-01, -2.55182560e-01, 3.95615259e-01],
                    vec![3.34261319e-01, 3.40803908e-01, 1.71272995e-01],
                    vec![-3.55457419e-01, -1.61893593e-01, 4.38525033e-01],
                    vec![2.34314237e-01, 1.81669693e-01, 3.21458159e-01],
                    vec![-2.63691713e-01, -5.31317001e-02, 4.05225403e-01],
                    vec![3.91936642e-01, 1.00812929e-01, 3.27763845e-01],
                    vec![5.71135002e-02, 2.91271643e-01, -1.27590403e-01],
                    vec![4.56435758e-01, -4.28939023e-01, -3.24962036e-01],
                    vec![6.56949783e-02, 4.03276745e-02, -2.41523937e-01],
                    vec![3.34463909e-01, 2.60967921e-01, 3.85360970e-01],
                ],
            )
            .unwrap()
            .readonly();
            let charges = vec![
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
                1., -1., 1., -1.,
            ]
            .into_pyarray(py)
            .readonly();

            let result = real_space_sum(coords, charges, 6.0).unwrap();

			assert_almost_eq!(result, -44.448067, 1e-3);

			}
		)
        }

		#[test]
		fn test_reciprocal_sum() {
			Python::with_gil(|py| {
	
				let coords = PyArray2::from_vec2(
					py,
					&[
						vec![3.77701194e-01, 4.67772786e-01, -3.95522676e-01],
						vec![4.53757903e-01, 1.61092870e-01, -6.60387998e-02],
						vec![-4.64901145e-01, 4.32659892e-01, -3.74928594e-01],
						vec![2.22596395e-01, 1.83711841e-01, 2.37328646e-01],
						vec![4.98373169e-01, 1.26445312e-01, -1.51174544e-01],
						vec![4.13160461e-01, 1.48616234e-01, -1.30509139e-01],
						vec![-3.31410415e-02, -3.11451448e-01, 4.46678741e-02],
						vec![-2.08542425e-01, -1.15534852e-01, 3.74073110e-01],
						vec![4.72775687e-01, -4.39546850e-01, -4.67239205e-01],
						vec![-1.06151872e-01, 3.12583661e-01, -1.49799235e-01],
						vec![4.02121444e-01, -4.33214612e-02, -7.14701237e-02],
						vec![2.47579873e-01, 3.54881183e-02, -1.92733447e-01],
						vec![4.38331739e-01, 8.75849842e-02, -1.75260920e-02],
						vec![2.86596144e-04, -1.84851507e-01, 1.29260624e-01],
						vec![3.80144490e-01, -4.73704352e-02, -1.53959063e-01],
						vec![1.36975665e-01, 2.86562730e-02, -2.97376644e-01],
						vec![-4.72122298e-01, 6.48243819e-02, -1.88156805e-01],
						vec![-3.93054817e-01, -3.20061912e-01, 4.24409000e-01],
						vec![2.75965612e-01, 1.39040603e-01, 1.94285700e-01],
						vec![-4.07117465e-01, -1.17647360e-01, 3.85494219e-01],
						vec![2.35130661e-02, 3.71219391e-01, -2.98522219e-02],
						vec![3.65137372e-01, 1.09227494e-01, -2.03635520e-01],
						vec![-2.65471503e-02, 2.47973267e-01, -1.45101264e-02],
						vec![-2.01501012e-01, 2.39913144e-01, -1.59521211e-01],
						vec![-1.43043614e-01, 3.90157075e-01, -1.22480061e-01],
						vec![6.94346066e-03, 2.35248131e-01, -1.72255515e-01],
						vec![1.01782213e-01, 1.01274816e-01, -2.87894854e-01],
						vec![2.95897739e-03, 4.61762965e-01, -1.43430095e-01],
						vec![-4.61375238e-01, -3.56915139e-01, -3.50904730e-01],
						vec![1.71326214e-01, -3.90450699e-02, -2.69656080e-01],
						vec![1.29171165e-01, 8.79364478e-02, -2.13960055e-01],
						vec![-4.08181971e-01, -4.42019046e-01, -1.80808038e-01],
						vec![3.79849001e-01, 1.24091291e-01, -6.33223368e-02],
						vec![3.70160324e-01, 1.63952667e-01, 2.91069957e-01],
						vec![-3.91260518e-01, -3.78672858e-01, -2.18948391e-01],
						vec![-7.46225950e-02, 2.08635270e-01, -6.42851616e-02],
						vec![4.07199291e-01, 1.40113168e-01, 1.53735999e-01],
						vec![-3.67250791e-01, -7.76317285e-02, 3.16574417e-01],
						vec![-8.30342655e-02, 1.89581946e-01, -2.06135144e-01],
						vec![4.59006573e-01, 2.14991372e-02, -5.34543053e-02],
						vec![-4.27285538e-01, -3.11560366e-01, 2.61103416e-01],
						vec![4.67270332e-01, 3.80303104e-01, -3.76277215e-01],
						vec![1.94854636e-01, 2.53217719e-01, 2.97371036e-01],
						vec![-4.04240014e-01, -1.48777120e-01, 3.07487226e-01],
						vec![4.43056375e-01, 1.88313853e-01, 2.93368240e-01],
						vec![2.77614745e-03, -1.68517490e-01, 4.79581754e-02],
						vec![4.95884306e-01, -3.67631712e-01, -2.83912399e-01],
						vec![3.26911187e-01, 2.89984450e-01, 3.00251583e-01],
						vec![-1.54131681e-01, -2.33139819e-01, 1.20345374e-01],
						vec![-1.40877492e-01, 3.55995724e-01, -1.53574653e-03],
						vec![4.94569206e-01, 4.22566712e-01, -4.45820483e-01],
						vec![-4.35384046e-01, -4.61664180e-01, -4.55658509e-01],
						vec![-1.87760097e-01, 2.56380174e-01, -2.46867525e-01],
						vec![-4.44137013e-01, 4.85732588e-01, -2.98718100e-01],
						vec![-3.59824555e-01, -2.67196385e-01, 3.69482284e-01],
						vec![4.56303406e-01, 2.91226244e-01, 1.04002470e-01],
						vec![4.21446676e-01, 4.02682962e-01, -4.37765449e-01],
						vec![-1.15533366e-02, -2.41387446e-01, 7.03796823e-02],
						vec![3.64214248e-01, 4.63072953e-01, -4.76412179e-01],
						vec![-1.05298415e-01, -2.94039925e-01, 1.50283872e-01],
						vec![-1.12375784e-01, -1.64833750e-01, 1.43488219e-01],
						vec![3.46826571e-01, 2.28574574e-01, 2.42599038e-01],
						vec![-4.76251676e-01, -4.29063980e-01, -3.89826474e-01],
						vec![4.49527531e-01, -1.95216623e-02, -1.87915407e-01],
						vec![-3.47406092e-02, -3.01765480e-01, 1.21326882e-01],
						vec![4.51169865e-01, 8.70489443e-02, -9.37759563e-02],
						vec![2.85062465e-01, 1.04983498e-01, -2.11001882e-01],
						vec![3.38719745e-01, 8.43061802e-02, 2.70951971e-01],
						vec![4.25033721e-01, 2.56931170e-01, 2.60511527e-01],
						vec![2.44843491e-01, 9.91656627e-02, -1.40714067e-01],
						vec![4.74025323e-01, -4.95716958e-02, -1.13788008e-01],
						vec![2.79787555e-01, 2.18697220e-01, 1.90821462e-01],
						vec![3.37466366e-01, -3.75240106e-03, -1.04073086e-01],
						vec![4.77770722e-01, 4.36392549e-01, -3.11930455e-01],
						vec![8.56521368e-04, 2.24476194e-01, -8.91941006e-02],
						vec![4.40152875e-01, -4.61336403e-01, -3.94884904e-01],
						vec![5.30064196e-02, 4.14390688e-01, -9.92344735e-02],
						vec![-4.15114132e-01, -2.40202868e-01, 3.20162495e-01],
						vec![3.18634842e-01, 2.12838389e-01, 3.22030694e-01],
						vec![-1.76944650e-01, -2.85132073e-01, 1.82097861e-01],
						vec![3.46206222e-01, 1.92566586e-01, 1.49725780e-01],
						vec![-3.38259353e-01, -2.04589009e-01, 3.12254439e-01],
						vec![-6.08507287e-02, -3.55247217e-01, 1.66835398e-01],
						vec![3.19061794e-01, 3.59250634e-01, 2.53839640e-01],
						vec![-4.75594430e-01, -2.89397102e-01, 3.29959740e-01],
						vec![4.20298630e-01, 4.96687496e-01, -3.26161782e-01],
						vec![4.80441323e-01, -4.94889089e-01, -2.73069535e-01],
						vec![3.02278980e-01, 4.10111977e-01, 1.90029672e-01],
						vec![3.03690208e-01, 2.88832030e-01, 2.22036970e-01],
						vec![3.71085757e-01, 1.81315547e-01, 3.79726469e-01],
						vec![2.46055499e-01, 1.12560056e-01, -3.38202741e-01],
						vec![2.53386814e-01, -1.78929971e-02, -2.49464027e-01],
						vec![4.05214909e-01, 4.10105666e-01, -3.34433073e-01],
						vec![3.76908447e-01, 7.59017982e-02, -1.24073394e-01],
						vec![2.55543347e-01, 3.49367116e-01, 2.01469096e-01],
						vec![2.70614483e-01, 2.38245509e-01, 2.68762155e-01],
						vec![-4.79099209e-02, 3.38432391e-01, -3.66475091e-02],
						vec![-1.11631398e-01, 2.39969884e-01, -2.68114803e-01],
						vec![-7.85484823e-02, 4.42541394e-01, -1.28513381e-01],
						vec![-4.87158122e-01, 8.90287311e-02, -4.34304063e-02],
						vec![8.80513050e-02, 3.48211556e-01, -7.86461123e-02],
						vec![4.17553429e-01, 2.22880566e-01, 1.21514617e-01],
						vec![-3.91219739e-01, -1.98525547e-01, 3.81626961e-01],
						vec![-4.26231945e-02, -3.40461873e-01, 2.47310909e-01],
						vec![3.85283742e-01, 3.87045182e-01, 2.23608151e-01],
						vec![6.56340545e-02, -2.25296571e-01, 1.11822304e-01],
						vec![-2.17664214e-01, -4.66996928e-02, 3.41317789e-01],
						vec![-1.89168847e-01, 3.19032940e-01, -1.17512681e-01],
						vec![-4.79833599e-01, -2.94722580e-01, -1.45902016e-01],
						vec![-1.44635979e-01, -3.60491457e-01, 1.56546745e-01],
						vec![-2.90397148e-02, 4.28763987e-01, -6.71517617e-02],
						vec![4.11168791e-01, 3.33998656e-01, 1.61770732e-01],
						vec![3.82923043e-02, -3.02080921e-01, 9.68166432e-02],
						vec![3.68637844e-01, -4.60443818e-01, -3.57589200e-01],
						vec![3.79603476e-01, 3.11113233e-01, 2.32751804e-01],
						vec![-8.52466827e-02, 3.75592972e-01, -1.92532857e-01],
						vec![1.26364213e-02, -2.54460253e-01, 1.62090106e-01],
						vec![-7.67096911e-03, 3.84078154e-01, -1.73984634e-01],
						vec![-4.32339047e-01, 4.55538704e-01, -4.43909234e-01],
						vec![-3.57049663e-01, -3.56615653e-01, 2.72474655e-01],
						vec![3.12679265e-01, 1.72496798e-01, -2.17340384e-01],
						vec![1.96560075e-01, -2.39495668e-02, -1.85588940e-01],
						vec![3.11050830e-01, 7.16702977e-02, -7.97699740e-02],
						vec![1.85871693e-01, 3.23512862e-02, -2.42677992e-01],
						vec![2.35828477e-01, 1.71010536e-01, -1.87968101e-01],
						vec![4.64388043e-01, -3.68036663e-01, -3.88195006e-01],
						vec![3.83691323e-01, 4.11356827e-02, -5.40120242e-02],
						vec![3.87792810e-01, 2.46960592e-01, 3.30433049e-01],
						vec![-4.00095275e-01, -4.54891260e-01, -2.59316185e-01],
						vec![-4.86549245e-02, -1.23427320e-01, 1.15749671e-01],
						vec![-4.67504027e-01, -4.33311949e-01, -3.06276964e-01],
						vec![4.66347252e-01, 3.34131357e-01, 2.27100230e-01],
						vec![1.68617784e-03, 3.20119317e-01, 2.63826456e-02],
						vec![3.75718434e-01, 2.92656858e-01, 9.97098251e-02],
						vec![4.79161754e-01, -3.56596153e-01, -1.97860698e-01],
						vec![2.80634327e-01, 2.81675545e-01, 1.45348616e-01],
						vec![3.24867809e-01, 1.33719407e-01, -1.42283063e-01],
						vec![-1.02137496e-01, 4.05103683e-01, -5.60489166e-02],
						vec![1.55722521e-01, 1.57432153e-01, -2.47576099e-01],
						vec![-4.98475883e-01, 3.31366733e-02, -1.24015753e-01],
						vec![3.20495130e-01, 1.11728824e-01, -2.86993086e-01],
						vec![-2.66372458e-01, -1.73641493e-01, 3.44649634e-01],
						vec![4.60205323e-01, -4.26438363e-01, -2.42603899e-01],
						vec![-4.63618997e-01, -1.86387743e-01, 3.54348281e-01],
						vec![-1.82628644e-01, 2.98561217e-01, -3.52537701e-02],
						vec![-1.01054591e-01, 3.09376286e-01, -2.34044705e-01],
						vec![-9.19883377e-02, -3.46024858e-01, 8.80814617e-02],
						vec![-8.45175964e-02, 3.22430513e-01, 3.74745658e-02],
						vec![8.00506627e-03, 3.49170637e-01, -1.01891658e-01],
						vec![2.53377904e-01, 3.18679924e-01, 2.80877738e-01],
						vec![-4.04673536e-01, -3.23900478e-01, 3.38202067e-01],
						vec![2.47633047e-01, 1.47861635e-01, -2.62719501e-01],
						vec![-3.51308208e-01, -2.77110047e-01, 2.80635162e-01],
						vec![2.27133548e-01, 2.72703331e-01, 2.15075045e-01],
						vec![4.24713602e-01, 1.40446519e-02, -1.24378405e-01],
						vec![-4.89998903e-02, 3.94840107e-01, 2.02881790e-02],
						vec![-1.70087707e-02, -1.72378141e-02, -3.50283866e-01],
						vec![2.06709851e-01, 1.00194697e-01, -2.12926319e-01],
						vec![-4.51396873e-01, -3.33059771e-01, -2.38084990e-01],
						vec![2.62807328e-01, 9.73876338e-03, -1.17357527e-01],
						vec![2.81194114e-01, 1.95121989e-01, 3.97041481e-01],
						vec![3.64962747e-01, 2.66624594e-01, 1.73294057e-01],
						vec![-1.23852253e-01, 3.30062332e-01, -7.49886693e-02],
						vec![2.92093029e-01, 1.62630716e-01, 2.67234898e-01],
						vec![4.08139390e-01, 3.65011957e-01, 8.45503005e-02],
						vec![-9.00730724e-02, -2.65533060e-01, 6.91048412e-02],
						vec![-4.31002207e-02, 2.55861720e-01, -2.31339910e-01],
						vec![7.02434558e-02, 1.29653943e-02, -3.35657227e-01],
						vec![-4.64214099e-01, 4.95110899e-01, -2.21082821e-01],
						vec![-1.10004706e-01, 2.69982680e-01, -2.54592133e-02],
						vec![4.46760606e-01, 2.64348603e-01, 1.85677455e-01],
						vec![3.02285726e-02, 2.92300886e-01, -4.79888956e-02],
						vec![4.43996811e-02, -1.84543655e-01, 1.93128056e-01],
						vec![-3.36207996e-01, -1.41968118e-01, 3.60766036e-01],
						vec![1.26406405e-01, 8.10985138e-03, -2.05395640e-01],
						vec![-7.28920761e-02, -1.87152383e-01, 6.92951511e-02],
						vec![1.48144138e-02, -2.29317186e-02, -2.66307759e-01],
						vec![5.98978884e-02, -6.87312693e-02, -3.27315042e-01],
						vec![9.23156878e-02, -2.82430154e-02, -2.68680126e-01],
						vec![-1.63273309e-01, -3.11237477e-01, 1.00538181e-01],
						vec![1.80832880e-01, 9.22692895e-02, -2.93506161e-01],
						vec![4.35539253e-01, 4.79588236e-01, -4.56976074e-01],
						vec![-1.28059366e-01, 2.49503877e-01, -1.87661383e-01],
						vec![-4.06804930e-01, -3.05506209e-01, -1.81515910e-01],
						vec![3.71324494e-01, 4.03590748e-01, 1.45723848e-01],
						vec![-1.73955881e-01, 3.09493462e-01, -1.94314106e-01],
						vec![-3.84417466e-02, -1.91553790e-01, 1.99980717e-01],
						vec![1.44193289e-01, -4.00802906e-02, -3.43390991e-01],
						vec![-1.36009895e-01, 1.85883029e-01, -1.36033813e-01],
						vec![-3.26975289e-01, -3.39683956e-01, 3.53108641e-01],
						vec![-2.83932360e-02, 3.04250296e-01, -1.59114559e-01],
						vec![5.52510622e-02, -2.81564920e-02, -1.95294343e-01],
						vec![3.25154413e-01, 3.51400204e-01, 9.68298595e-02],
						vec![-1.10975352e-02, -8.49231665e-02, -3.04390420e-01],
						vec![3.70803187e-02, 3.02825529e-01, -2.03135657e-01],
						vec![-4.15688350e-01, -3.73003235e-01, -2.92195282e-01],
						vec![-4.24460483e-01, 4.98788682e-01, -3.78531605e-01],
						vec![4.46338949e-01, 6.86628714e-02, -1.78692391e-01],
						vec![2.02515201e-01, 1.63353302e-02, -3.32020312e-01],
						vec![-6.16032817e-02, -2.30115238e-01, 1.34744223e-01],
						vec![4.17152468e-01, 1.95000187e-01, 2.15314122e-01],
						vec![-2.79341826e-01, -1.38410049e-01, 4.15417654e-01],
						vec![4.20551944e-01, 1.14538696e-01, 2.46529065e-01],
						vec![3.08458911e-01, -1.92643328e-02, -1.80779706e-01],
						vec![2.55671554e-01, 2.63817679e-01, 3.46900622e-01],
						vec![1.17391304e-01, -9.93796714e-02, -2.83815940e-01],
						vec![5.16285016e-02, -1.50447283e-01, -3.15692304e-01],
						vec![-4.94484036e-01, 4.99452234e-01, -4.24682964e-01],
						vec![1.63013528e-01, 1.35825255e-01, -1.48009917e-01],
						vec![-1.61461773e-01, 1.86567530e-01, -2.21412057e-01],
						vec![-1.33666958e-01, 2.58063514e-01, -1.01627471e-01],
						vec![-3.05703868e-01, -2.08793158e-02, 3.45188950e-01],
						vec![-2.80657345e-01, -9.91229355e-02, 3.38150335e-01],
						vec![3.51525337e-01, 1.46618934e-01, 2.17836604e-01],
						vec![4.01356056e-02, -9.19206745e-02, -2.43146965e-01],
						vec![3.05281392e-01, 1.64823238e-02, -3.12086971e-01],
						vec![-4.77764087e-02, -2.80145095e-01, 2.00107647e-01],
						vec![-3.36650723e-01, -7.97556606e-02, 4.10142344e-01],
						vec![7.00477036e-02, 3.64889240e-01, -1.57670243e-01],
						vec![3.19953662e-01, 4.23781081e-02, -2.38936192e-01],
						vec![4.36856660e-01, 4.27802527e-01, 4.87861900e-01],
						vec![-2.91369105e-01, -2.62473385e-01, 3.32748836e-01],
						vec![-4.04201698e-01, -4.19792279e-01, -3.53451113e-01],
						vec![1.76248512e-02, -3.28077314e-01, 1.93457432e-01],
						vec![-4.51601900e-01, -3.75871232e-01, -1.62791884e-01],
						vec![4.99998240e-01, -4.95657758e-01, -3.47191966e-01],
						vec![-6.59323826e-02, 3.66110921e-01, -1.11371830e-01],
						vec![-5.89341479e-02, 2.82229958e-01, -8.90534483e-02],
						vec![3.78586403e-01, 2.64714277e-02, -1.93107831e-01],
						vec![-1.94142252e-01, 3.75038541e-01, -5.75783057e-02],
						vec![2.51702293e-01, 6.56584860e-02, -2.74721859e-01],
						vec![-3.10135906e-01, -2.12696643e-01, 3.96982622e-01],
						vec![-4.97591343e-01, 4.79490667e-01, 4.98702364e-01],
						vec![-3.71063875e-01, -2.40005973e-01, 4.45749352e-01],
						vec![-6.62542922e-02, 2.29546938e-01, -1.44476391e-01],
						vec![3.11359054e-01, 5.51626618e-02, -1.59196526e-01],
						vec![1.20774860e-01, -6.78832281e-02, -2.08624018e-01],
						vec![-4.62669672e-01, -4.13772164e-01, -2.28853942e-01],
						vec![-1.15103420e-01, -3.21082909e-01, 2.23354433e-01],
						vec![1.13197106e-01, -1.08655438e-01, -3.68503749e-01],
						vec![-1.13500797e-01, -2.31398756e-01, 1.98457475e-01],
						vec![-4.96123065e-01, -4.44867900e-01, -1.66589922e-01],
						vec![-2.67588850e-02, 3.33915727e-01, -2.35507333e-01],
						vec![3.14707468e-01, 1.37444869e-01, 3.40461103e-01],
						vec![1.77936002e-01, 5.06242993e-02, -1.55197769e-01],
						vec![4.51834828e-01, 4.56226045e-01, -3.86026957e-01],
						vec![-4.40499801e-01, -2.55182560e-01, 3.95615259e-01],
						vec![3.34261319e-01, 3.40803908e-01, 1.71272995e-01],
						vec![-3.55457419e-01, -1.61893593e-01, 4.38525033e-01],
						vec![2.34314237e-01, 1.81669693e-01, 3.21458159e-01],
						vec![-2.63691713e-01, -5.31317001e-02, 4.05225403e-01],
						vec![3.91936642e-01, 1.00812929e-01, 3.27763845e-01],
						vec![5.71135002e-02, 2.91271643e-01, -1.27590403e-01],
						vec![4.56435758e-01, -4.28939023e-01, -3.24962036e-01],
						vec![6.56949783e-02, 4.03276745e-02, -2.41523937e-01],
						vec![3.34463909e-01, 2.60967921e-01, 3.85360970e-01],
					],
				)
				.unwrap()
				.readonly();
				let charges = vec![
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1.,
					1., -1., 1., -1.,
				]
				.into_pyarray(py)
				.readonly();
	
				let result = reciprocal_space_sum(8, coords, charges, 6.0).unwrap();
	
				assert_almost_eq!(result, -391.598280, 1e-3);
	
				}
			)
			}
    }

